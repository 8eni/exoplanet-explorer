<script>
	var Model = (function(document) {
  'use strict';

  var exports = {};

  var database = {
    _database: [],
    _index: {},
    _requestInProgress: false,
    _debounceReturn: null,
    _requestAllPlanets: function() {
      var self = this;
      
      // debounce requests first
      if (self._requestInProgress) {
        return new Promise(function() {
          self._debounceReturn = function(planets) {
            resolve(planets);
          };
        });
      }

      // create the request
      self._requestInProgress = true;
      return getJSON('/data/data.json').then(function(planets) {
        self._database = [];
        planets.forEach(function(planet) {
          self._loadPlanetIntoDatabase(planet);
        })

        // return any promises waiting to be debounced
        if (self._debounceReturn) {
          self._debounceReturn(planets);
        }
        // no longer requesting, so unflag debouncing flags
        self._debounceReturn = null;
        self._requestInProgress = false;

        return planets;
      })
      .catch(function() {
        throw new Error('Planet Parsing Error');
      });
    },
    _requestOnePlanet: function(name) {
      return getJSON('/data/planets/' + name + '.json');
    },
    fullSearch: function(item) {
      // regex for item in _database. if any property hits, return it
    },
    specificSearch: function(property, criteria) {
      // criteria is an object with value, upper, lower
    },
    _loadPlanetIntoDatabase: function(planetData) {
      this._database.push({name: planetData.pl_name, data: planetData});
      this._index[planetData.pl_name] = this._database.length - 1;
    },
    _exists: function() {
      if (this._database.length > 0) {
        return true;
      } else {
        return false;
      }
    },
    getPlanetByName: function(name) {
      var self = this;
      // no spaces in the planet json urls
      name = name.replace(/ /g,'');

      return new Promise(function(resolve, reject) {
        var planetData = self._database[self._index[name]];
        if (planetData) {
          resolve(planetData);
        } else {
          // requests all the data for use later
          self._requestAllPlanets();
          // returns a promise for this planet's data
          resolve(self._requestOnePlanet(name));
        }
      });
    },
    init: function() {
      var self = this;
      return new Promise(function(resolve) {
        if (self._exists()) {
          resolve();
        } else {
          resolve(self._requestAllPlanets());
        }
      })
    }
  };
  exports.database = database;

  function get(url) {
    // Return a new promise.
    return new Promise(function(resolve, reject) {
      // Do the usual XHR stuff
      var req = new XMLHttpRequest();
      req.open('GET', url);

      req.onload = function() {
        // This is called even on 404 etc
        // so check the status
        if (req.status === 200) {
          // Resolve the promise with the response text
          resolve(req.response);
        }
        else {
          // Otherwise reject with the status text
          // which will hopefully be a meaningful error
          reject(Error(req.statusText));
        }
      };

      // Handle network errors
      req.onerror = function() {
        reject(Error('Network Error'));
      };

      // Make the request
      req.send();
    });
  }

  function getJSON(url) {
    return get(url).then(JSON.parse).catch(function() {
      throw new Error('AJAX Error');
    });
  };

  window.addEventListener('WebComponentsReady', function() {
    // nothing for now
  });

  return exports;
})(document);

</script>